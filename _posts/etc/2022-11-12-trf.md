---
layout: single
title:  "테라폼 자체 제작 모듈을 활용한 배포환경 구성 자동화"
categories: 'etc'
---

# 테라폼 자체 제작 모듈을 활용한 배포환경 구성 자동화

---

## 본문요약

1. 퍼블릭 서브넷: ALB / 프라이빗 서브넷: EC2 가 위치한 기본 구성

2. 간단해 보여도, IaC tool(테라폼)으로 구성하려면 여러 설정이 필요
    - VPC network
        - VPC & Subnet CIDRs, igw & NAT, Routing tables, etc...
    - ALB
        - Subnet mapping, Listener rule & Target group, etc...
    - EC2
        - AMI, Instance type, Security groups, etc...

3. 해당 구성을 자주 사용한다면, 어떻게 재사용성을 높일 수 있을까?
    - 필요 변경값만을 정의하고 변수화하여 해당 값 변경으로 새로운 세트 생성
    - 별도의 변수값 파일을 생성 및 관리하여 수동 입력시 발생할 수 있는 Human error 최소화

[프로젝트 관련 GIT Repository]()

---

## !모듈 왜써요? / !모듈 왜 만들어써요?

위의 본문요약에도 간단히 적어둔것처럼, 테라폼을 통해 생성 및 관리되는 리소스 중 반복되는 리소스가 많다면 모듈을 사용해 재사용성을 높일 수 있다.


일반적인 모듈의 장점은 Docs나 다른 블로그들에 잘 나와있고


개인적으로 셍각하는 모듈을 써야하는 이유/만들어 써야하는 이유는 아래와 같다.   

1. Human Error 방지
    - 보안그룹이나 인스턴스등의 naming convention 유지
    - 태그 누락등 방지
    - 오타 및 복붙시 변경 사항 누락 등 찾기 용이함
        - aaa를 복붙해서 bbb로 변경해야하는데 못보고 aaa로 생성
2. 필요한 변경 사항만 빠르게 작업가능
    - 몇백줄의 main.tf 중에서도 변경이 필요한 부분은 일부임 

---

## 중점적으로 고민했던 부분들

- 어디까지 모듈로 만들고 각 모듈마다 어떤 리소스를 배정할것인가?
    - 한두번만 쓰고 말거면 모듈로 구성할 필요가 있는가?
        - Backend(S3 bucket, DynamoDB key)등은 별도 생성해서 복붙사용
    - 몇개의 모듈을 만들어서 사용할 것인가?
        - VPC, ALB, EC2 3개의 모듈 생성 및 연동
            - VPC-ALB-EC2 모두 묶은 1개의 모듈로도 구성 가능. But,
                - 기 VPC에 ALB-EC2 세트만 추가생성 할수도 있고
                - ALB 없이 퍼블릭에 EC2만 생성하고 싶을 수도 있음
    - 각 모듈마다 어떤 리소스가 배정되야하고 어느부분이 자주 변경되는가?
        - All: project_name
        - VPC: CIDRs(VPC,Subnet), etc...
        - ALB: sec_grps(ingress),Target grps, etc...
        - EC2: instance_type, amount, etc...

- 해당 고민을 하고난 뒤 기존의 짜여진 모듈들을 보고 컨닝함. 
    - [aws-vpc](https://registry.terraform.io/modules/terraform-aws-modules/vpc/aws/latest), [aws-alb](https://registry.terraform.io/modules/terraform-aws-modules/alb/aws/latest),[aws-ec2](https://registry.terraform.io/modules/terraform-aws-modules/ec2-instance/aws/latest) 

- 모듈간의 산출믈을 서로 어떻게 넘겨줄것인가
    1. Resource.local_file 사용
        - [local_file](https://registry.terraform.io/providers/hashicorp/local/latest/docs/resources/file) 리소스를 사용해 별도 산출물 파일을 생성해 다른 모듈의 경로에 던져주기
        - ex)
        ```HCL
        /modules/00network/nw-output.tf
        resource "local_file" "example {
          content = <<EOF
        variable "vpc_id" = "${aws_vpc.vpc.id}"
        이하 생략
        EOF
          filename = "../02ec2/nw_output.tf"
        }
        ```

    2. Module Output 사용 
        - [Accessing Module Output Values](https://developer.hashicorp.com/terraform/language/modules/syntax#accessing-module-output-values) 모듈간 참조할 값을 output으로 뺴놓고, output을 타 모듈의 input으로 넣어주기
        - ex)
        ```HCL
        /modules/00network/nw-output.tf
        output "vpc_id" {value = aws_vpc.vpc.id}
        이하 생략

        /dev/aaa/aaa-main.tf
        module "aaa-ec2" {
          vpc_id = module.aaa-network.vpc_id
          이하 생략
        }
        ```

    3. Tag 기반 Data source 사용
        - [Dependency Inversion](https://developer.hashicorp.com/terraform/language/modules/develop/composition#dependency-inversion) 모듈간 참조할 값을 개별 module마다 data source로 받아와서 사용
        - ex)
        ```HCL
        /modules/02ec2/ec2-variable.tf
        data "aws_vpc" "this" {tags={Name="dev"}}

        /modules/02ec2/ec2-template.tf
        resource "aws_instance" "this" {
          vpc_id = data.aws_vpc.this.id
        }

    - So?
        - 3번 채택
            - 개별 모듈안에는 template & variable만 남겨두고 싶음
            - 최상위 input에는 수동입력이 필요한것만 남기고 나머지는 다 안보이게 치워두고 싶음


---

## 구축 Architecture 


## Project Structure

---

## 프로젝트 상세 설명

### /
최상위 디렉토리     
modules과 각 환경(dev,prd)등이 디렉토리로 구성되어있음  

### /modules
modules 디렉토리        
하위 모듈로 network, alb, ec2가 있음    

#### /modules/00network
VPC N/W 구성을 담당하는 모듈    

#### /modules/01alb
AWS ALB 구성을 담당하는 모듈    

#### /modules/02ec2
AWS EC2 구성을 담당하는 모듈

아니 이렇게 쓰는게 맞나

### /dev

#### /dev/aaa
#### /dev/bbb
#### /dev/ccc
---
## 개선 해야될 부분


---

## Reference

- 
[Standard Module Structure](https://developer.hashicorp.com/terraform/language/modules/develop/structure)


https://medium.com/codex/terraform-best-practices-using-variables-c96c93458075
