---
title:  "220415 Today I Learned"
categories: 'til'
---
<!-- 
![aas](/assets/til/220328til1.png)

<img src="/assets/til/220328til1.png" width="100%" height="100%"> -->



### ì¼ì§€

ìµœì•…ì˜ ì¼ì£¼ì¼ì´ì˜€ë‹¤   

ë‚´ ìŠ¤íƒ€ì¼ì€ ë„ˆë¬´ ëª…í™•í•˜ê³   
í˜„ì¬ ê°•ì‚¬ë‹˜ì€ ê·¸ ìŠ¤íƒ€ì¼ê³¼ ë§ì§€ ì•Šìœ¼ë‹ˆ  
ë­˜ í•´ì•¼í•˜ë‚˜ ì–´ë–»ê²Œí•´ì•¼í•˜ë‚˜í•˜ë©´ì„œ  
ì¢€ ë°©í™©í•˜ë©´ì„œ ê³µë¶€ ë™ë ¥ë„ ì¢€ ìƒì–´ë²„ë¦°ëŠë‚Œ?  

ë‚´ì¼ì€ ì£¼ë§ì´ê³  ë©˜í† ë‹˜ íŠ¹ê°•ë„ ìˆìœ¼ë‹ˆê¹Œ  
ë³µêµ¬ì¢€í•˜ì..ğŸ’ª

ì•¤ì„œë¸”ì‚¬ìš©í•´ì„œ LAMP ì„œë²„êµ¬ì¶•í•˜ê³  Wordpress ê¹Œì§€ êµ¬ì¶•í•˜ëŠ” Playbookì„ ìƒì„±í•˜ë©´ ë˜ë ¤ë‚˜?  
ì•„ë§ˆì¡´ ec2 ì¸ìŠ¤í„´ìŠ¤ ìë™ìƒì„± taskë„ ì°¾ì•„ì„œ ë¶™ì´ê³   
web ì¸ìŠ¤í„´ìŠ¤ë‘ dbì¸ìŠ¤í„´ìŠ¤ êµ¬ë¶„í•´ì„œ í• ìˆ˜ìˆìœ¼ë ¤ë‚˜  

ê·¸ëŸ¬ë©´ ê·¸ì‚¬ì´ì— mysql ì—°ë™ì„¤ì •ê°™ì€ê²ƒë„ í• ìˆ˜ìˆë‚˜?   
ê·¸ê±°ê¹Œì§€ í•  ìˆ˜ ìˆìœ¼ë©´ ë‹¤ë‹¤ìŒì£¼ ë¯¸ë‹ˆ í”„ë¡œì íŠ¸ ì§„í–‰í• ê±´ ë‹¤í•œê±°ê² ì§€. í™”ì´íŒ…   

í  ê·¼ë° ì € ppt ê·¸ëƒ¥ íšŒì‚¬ìë£Œê°€ì ¸ì™€ì„œ í•˜ëŠ”ê±´ì¤„ ì•Œì•˜ëŠ”ë°
ë¶„ëŸ‰ ì¶”ê°€ë˜ê³  ë‚´ìš© ì¢€ ë³´ë‹ˆê¹Œ ê°•ì‚¬ë‹˜ì´ ì§ì ‘ ë§Œë“œì‹ ê±° ê°™ê¸´í•˜ë„¤
ìŒ.. ê·¸ë˜ë„ ì•„ì˜ˆ ë…¸ë ¥ì„ ì•ˆí•˜ì‹œëŠ”ê±´ ì•„ë‹Œê°€ ë³´êµ¬ë‚˜. ì‚´ì§ í‰ê°€ ì •ì •

**ì£¼ìš” í‚¤ì›Œë“œ**


### ì˜¤ëŠ˜ì˜ í• ì¼

- [x] 220415 TIL ì‘ì„±
- [ ] Ansible ê³µì‹ë¬¸ì„œì½ì–´ë³´ê¸°


### ì¶”ê°€ë¡œ ì •ë¦¬í•´ì•¼í•  ë¶€ë¶„

ansible ê°œë… ë‹¨ì–´ë“¤ ì •ë¦¬
fact, template, loop, conditionals, blocks, handlers, role....

### ìˆ˜ì—… ì •ë¦¬

21. Breaking A Playbook Into A Role Part - 1


22. Breaking A Playbook Into A Role Part - 2 (1:26:00)

```
ansible-galaxy init common
vi ntp.yml
---
- name: install ntp
  yum: name=ntp state=present

- name: configure ntp file
  template: src=ntp.conf.j2 dest=/etc/ntp.conf
  notify: restart ntp

- name: start the ntp service
  sevice: name=ntpd state=started enabled=yes
```

```
---
- name: restart ntp 
sevice: name=ntpd state=restarted 
```

ëë‚˜ê³ ë‚˜ë©´ ~/pjt/roles/common/tasksì— main, ntp, selinux YAMLíŒŒì¼ìƒì„±

```
---
- include: selinux.yml
- include: ntp.yml
```


23. Declaring Roles In Main Playbook(1:29:53)

```
~/pjt
vi site.yml
---
- name:deploy common and mariadb role
  hosts: testserver
  remote_user: ec2-user
  become: yes

  roles: 
  - common
  - mariadb

ansible-playbook -i hosts site.yml
```

24. Role Dependencies (1:32:33)

```
---
- name: install httpd and firewalld
  yum: name={item} state=present
  with_items:
  - httpd
  - firewalld

- name: start firewalld
  service: name=firewalld state=started enabled=yes

- name: insert firewalld rule for httpd
  firewalld: port={httpd_port}/tcp permanent=true state=enabled immediate=yes

- name: start httpd
  service: name=httpd state=started enabled=yes
...
```


25. Privilege Escalation (1:36:50)

idea of becoming another user

```
vi ansible.cfg

[privilege_escalation]


```

1. become is the new syntax as of 2.0 if 1.9, pseudo
2. make your user is privileged
3. can't limit to certain commands 
4. become can't be chained

```
vi site.yml

- name:deploy common and mariadb role
  hosts: testserver
  remote_user: ec2-user
  become: yes
  become_user: postgres
  become_method: pbrun
> ë§Œì•½ ë°ì´í„°ë² ì´ìŠ¤ì‘ì—…ì´ìˆê³ , í•´ë‹¹ìœ ì €ë§Œí•„ìš”í•˜ë‹¤ë©´
or
  become_user: michelle

ansible-playbook -i hosts site.yml -vvvv # 4v > debug level verbosity, can see actuall user change
```

26. Delegation And Local Actions Ansible (1:42:10)

delegatimg a task to specific server

```
~/pjt vi testdelegate.yml

---
- name: test delegate
  hosts: testserver
  remote_user: ec2-user
  become: yes

  task:
  - name: restart machine
    shell: sleep 2 && shutdown -r now "Ansible updates have happend"
    async: 1
    poll: 0
    ignore_errors: True

  - name: waiting for server to come back
    wait_for: host={inventory_hostname} state=started delay=30 timeout=300
    become: no
    delegate_to 127.0.0.1

  - name: waiting for server to come back
    local_action: wait_for host={inventory_hostname} state=started delay=30 timeout=300
    become: no
    
why use delegate?
In 1st tasks, we'll lose connection to host, but wanna keep playbook going

by local action, we can shorten

---
- name: test delegate facts
  hosts: testserver
  remote_user: ec2-user
  become: yes

  task:
  - name: gather local facts
    setup: 
    delegate_to: 127.0.0.1
    delegate_facts: true
    
ansible-playbook -i host testdelegate.yml
```


27. Error Handling (1:48:15)
error handling is a broad term to cover ways to handle potential failures in ur ansible

```
~pjt vi testerrors.yml

---
- name: testing error handling
  hosts: testserver
  remote_user: ec2-user
  become: yes

  task:
  - name: testing ignore errors
    user: name=michelleP password={uPassword}
    ignore_errors: yes 

  - name: next task
    shell: echo hello world

  - name: quick echo
    shell: echo $PATH
    register: result

  - debug: msg="Stop running playbook if the play failed"
    failed_when: result|failed

  - name: echo failed
    shell: echo I failed
    register: output

  - debug: msg="Okay really stop the playbook"
    failed_when: output.stdout.find('failed')!=-1

  - name: just adding another task in here to show you that it will stop
    shell: echo hello world

ansible-playbook -i host testerrors.yml
```


28. Check Mode And Debugging Playbooks Part - 1 (1:53:05)

checkrun by drydun
```


29. Check Mode And Debugging Playbooks Part - 2 (1:58:15)

ì „ë°˜ì ìœ¼ë¡œ ì˜ìƒë³´ë©´ì„œ ì˜¤ë¥˜ ë©”ì‹œì§€ë‘ ìˆ˜ì •ë°©ë²• ì²´í¬í•˜ë©´ëŒˆë“¯

30. Windows Support Part - 1 (2:03:10)

ìœˆë„ìš° hostì„œë²„ ì¤€ë¹„ê³¼ì •
ì¸ë²¤í† ë¦¬ ë³€ìˆ˜ì™€ í˜¸ìŠ¤íŠ¸íŒŒì¼ ì„¤ì •
win_pingìœ¼ë¡œ ì—°ê²°ìƒíƒœ í™•ì¸

ìœˆë„ìš°ì—ì„œëŠ” ssh ì‚¬ìš©ëª»í•¨. winrm

```
- name: testing windows module
  hosts: windows

  vars: 
    uPassword: w!ndowS

  task:
  - name: run ipconfig
    raw: ipconfig
    register: ipconfig

  - debug: var=ipconfig

  - name: test stat module on file
    win_stat: path="C:/Windows/win.ini"
    register: stat_file

  - debug: var=stat_file

  - name: add a local group
    win_group: name=TestWindowsGroup description="My Windows group" state=present

  - name: add a local user
    win_user: name=TestUser password={uPassword} groups=TestWindowsGroup group_action=add

  - name: give my local user some permissons
    win_acl:
      path: "C:\\User\\Public"
      user: TestUser
      rights: FullControl
      type: allow

```


31. Windows Support Part - 2 (2:09:00)
 Part1ì—ì„œ ìƒì„±í•œ í”Œë ˆì´ë¶ ì‘ë™ ë° ê²°ê³¼ ì„¤ëª…

```
vi windows.yml



```

32. EC2 Dynamic Inventory Part - 1

host íŒŒì¼ì—ì„œ ì¸ë²¤í† ë¦¬ë¥¼ ê´€ë¦¬í–ˆì§€ë§Œ,
aws ec2ì— ì ìš©í•  ê²½ìš° ex2 ì™¸ë¶€ ì¸ë²¤í† ë¦¬ ìŠ¤í¬ë¦½íŠ¸

ec2 file ìƒì„±í•˜ê¸°

ec2 í´ë”ë¥¼ ìƒì„±í•˜ê³ , keypair.ymlì™€ ë¼ì´ë¸ŒëŸ¬ë¦¬ í´ë” ìƒì„± 
ec2.py
ec2.ini  inventory for ec2
chmod +x ec2.py
pip install boto

iam, get security credential and down access&secret access key

in part2, write a playbook to utilize some ec2

33. EC2 Dynamic Inventory Part - 2 (2:19:25)

In part1, set up process, confirm connectivity w/amz by ./ec2.py --list   

```
vi playbook.yml

- name: launching an ec2 instance
  hosts: localhost
  connection: local
  gather_facts: false

  vars_files: 
    - keypair.yml

  task:
  - name: search for the latest rhel 7 ami
    ec2_ami_find:
      region: us-east-1
      owner: "309956199498"
      name: "RHEL-7.2*"
    register: find_results

  - debug: var=find_results

  - name: find a subnet id
    ec2_vpc_subnet_facts:
      aws_access_key: "{ec2_access_key}"
      aws_secret_key: "{ec2_secret_key}"
      region: us-east-1
    registe: subnet_ids

  - debug: subnet_ids

  - name: launch an ec2 instance
    ec2:
      aws_access_key: "{ec2_access_key}"
      aws_secret_key: "{ec2_secret_key}"
      instance_type: t2.micro
      region: us-east-1
      image: "{find_resultes.results[0].ami_id}"
      instance_tags:
        Name: mperz
      wait: yes
      vpc_subnet_id: "{subnet_ids.subnets[0].id}"
      assign_public_ip: yes

```

34. Ansible Vault (2:27:35)

vault is a feature that encrypts files w/sensitive data

ì´ì „ê°•ì˜ì—ì„œ í‚¤ë“¤ì´ ì•”í˜¸í™”ë˜ì–´ìˆì§€ì•Šì•˜ê¸°ë•Œë¬¸ì— ë§¤ìš° ì·¨ì•½í•œ ìƒí™©.

`ansible-vault encrypt keypair.yml`     
`cat keypair.yml`


ansible-playbook playbook.yml --ask-vault-pass

best practice for variables in vault

 create a dir. underneath my group_vars

cd windows 
vi vault 
ansible-vault enctypr vault

ë§Œì•½ì— ì•”í˜¸í™” í•´ì•¼ í•  ëŒ€ìƒì´ ë§ë‹¤ë©´
pip install cryptography